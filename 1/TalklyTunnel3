-- miner_a.lua
-- Turtle A: 3x3 Tunnel Mining Turtle

local modem = peripheral.find("modem")
if not modem then error("No modem attached") end
modem.open(10) -- outbound channel
modem.open(11) -- inbound channel

-- CONFIG
local fuelThreshold = 200
local inventoryThreshold = 13
local broadcastEverySteps = 5
local coordChannel = 10
local responseChannel = 11

-- STATE
local stepsMoved = 0
local stopMining = false
local homeCoords = nil
local path = {} -- history for returning home

-- UTILS
local function debugPrint(...) print("[A]", ...) end

local fuelItems = {"minecraft:coal","minecraft:charcoal","minecraft:coal_block"}

local function getPos()
    local x,y,z = gps.locate(2)
    return x,y,z
end

local function countInventory()
    local used=0
    for s=1,16 do if turtle.getItemCount(s)>0 then used=used+1 end end
    return used
end

local function refuelFromInventory()
    for s=1,16 do
        local d=turtle.getItemDetail(s)
        if d then
            for _,name in ipairs(fuelItems) do
                if d.name==name then
                    turtle.select(s)
                    turtle.refuel(1)
                    if turtle.getFuelLevel()>=fuelThreshold then return true end
                end
            end
        end
    end
    return false
end

-- MOVEMENT LOGGING
local function loggedForward()
    while turtle.detect() do turtle.dig() sleep(0.05) end
    if turtle.forward() then table.insert(path,"forward"); stepsMoved=stepsMoved+1; return true end
    return false
end
local function loggedUp()
    while turtle.detectUp() do turtle.digUp() sleep(0.05) end
    if turtle.up() then table.insert(path,"up"); stepsMoved=stepsMoved+1; return true end
    return false
end
local function loggedDown()
    while turtle.detectDown() do turtle.digDown() sleep(0.05) end
    if turtle.down() then table.insert(path,"down"); stepsMoved=stepsMoved+1; return true end
    return false
end

-- RETURN HOME
local function returnHome()
    debugPrint("Returning home...")
    for i=#path,1,-1 do
        local move=path[i]
        if move=="forward" then turtle.back()
        elseif move=="up" then turtle.down()
        elseif move=="down" then turtle.up() end
        sleep(0.05)
    end
    debugPrint("Home reached. Stopping.")
    while true do sleep(1) end
end

-- BROADCAST GPS EVERY N STEPS
local function broadcaster()
    while true do
        if stepsMoved % broadcastEverySteps==0 then
            local x,y,z=getPos()
            if x then modem.transmit(coordChannel,responseChannel,{tag="here", x=x,y=y,z=z}) end
        end
        sleep(0.5)
    end
end

-- AUTO MONITOR
local function autoMonitor()
    while true do
        local fl=turtle.getFuelLevel()
        if fl~="unlimited" and fl<fuelThreshold then modem.transmit(coordChannel,responseChannel,"needfuel") end
        if countInventory()>=inventoryThreshold then modem.transmit(coordChannel,responseChannel,"needempty") end
        sleep(1)
    end
end

-- RECEIVER
local function receiver()
    while true do
        local _,_,_,_,msg = os.pullEvent("modem_message")
        if type(msg)=="string" then
            if msg=="fuelready" then refuelFromInventory()
            elseif msg=="emptyready" then
                for s=1,16 do turtle.select(s) turtle.drop() end
            elseif msg=="stop" then stopMining=true
            elseif msg=="tunnel" then stopMining=false
            elseif msg=="home" then stopMining=true returnHome() end
        elseif type(msg)=="table" and msg.tag=="askcoords" then
            local x,y,z=getPos()
            if x then modem.transmit(coordChannel,responseChannel,{tag="here", x=x,y=y,z=z}) end
        end
    end
end

-- MANUAL PROMPT
local function manualPrompt()
    while true do
        write("Command (stop/home/tunnel/passfuel/getfuel): ")
        local cmd=read()
        if cmd=="stop" then stopMining=true
        elseif cmd=="tunnel" then stopMining=false
        elseif cmd=="home" then stopMining=true returnHome()
        elseif cmd=="passfuel" then
            for s=1,16 do
                local d=turtle.getItemDetail(s)
                if d and table.concat(fuelItems," "):find(d.name) then turtle.select(s) turtle.drop() break end
            end
        elseif cmd=="getfuel" then modem.transmit(coordChannel,responseChannel,"getfuel") end
    end
end

-- MINING 3x3 TUNNEL WITH HOPS
local function mine3x3Tunnel()
    local hopInterval = 2
    local stepCount = 0
    while true do
        if not stopMining then
            -- Dig Center
            loggedForward()
            loggedUp()
            loggedDown()
            -- Dig Left
            turtle.turnLeft()
            loggedForward()
            loggedUp()
            loggedDown()
            turtle.turnRight()
            -- Dig Right
            turtle.turnRight()
            loggedForward()
            loggedUp()
            loggedDown()
            turtle.turnLeft()
            stepCount=stepCount+1
            if stepCount % hopInterval==0 then loggedUp() loggedForward() loggedDown() end
        end
        sleep(0.1)
    end
end

-- RUN EVERYTHING
parallel.waitForAny(mine3x3Tunnel, manualPrompt, broadcaster, receiver, autoMonitor)